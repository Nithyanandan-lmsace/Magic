{"version":3,"file":"authmagic.min.js","sources":["../src/authmagic.js"],"sourcesContent":["// This file is part of Moodle - http://moodle.org/\r\n//\r\n// Moodle is free software: you can redistribute it and/or modify\r\n// it under the terms of the GNU General Public License as published by\r\n// the Free Software Foundation, either version 3 of the License, or\r\n// (at your option) any later version.\r\n//\r\n// Moodle is distributed in the hope that it will be useful,\r\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\r\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\r\n// GNU General Public License for more details.\r\n//\r\n// You should have received a copy of the GNU General Public License\r\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\r\n\r\n/**\r\n * Magic authentication define js.\r\n * @module   auth_magic\r\n * @copyright  2023 bdecent gmbh <https://bdecent.de>\r\n * @license   http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\r\n */\r\n\r\ndefine(['jquery', 'core/str', 'core/ajax'],\r\nfunction($, String, Ajax) {\r\n\r\n    /**\r\n    * Controls Custom styles tool action.\r\n    * @param {object} params\r\n    */\r\n    var AuthMagic = function(params) {\r\n        var self = this;\r\n        if (params.loginhook) {\r\n            self.magicLoginHook(params);\r\n        }\r\n\r\n        if (params.customloginhook) {\r\n            self.magicCustomLoginHook(params);\r\n        }\r\n\r\n        if (params.paymentgatbank) {\r\n            self.paymentgatbankaction(params);\r\n        }\r\n\r\n        return true;\r\n    };\r\n\r\n    AuthMagic.prototype.paymentgatbankaction = function(params) {\r\n        var self = this;\r\n        // Update the bank payment gatway amount.\r\n        var paymentTabletr = document.querySelectorAll(\"#page-content table tbody tr\");\r\n        var paymentTabletbody = document.querySelector(\"#page-content table tbody\");\r\n        if (paymentTabletbody) {\r\n            $(\"#page-content table tbody\").append('<tr class=\"loader-table\"><td colspan=\"9\"><i class=\"fa fa-circle-o-notch\"></i></td>');\r\n\r\n            if (paymentTabletr) {\r\n                paymentTabletr.forEach(function(item) {\r\n                    var element = item.querySelector('td form input[name=\"id\"]');\r\n                    if (element) {\r\n                        var entryid = element.value;\r\n                        self.setPaymentGatAmount(entryid, item);\r\n                    }\r\n                });\r\n            }\r\n            paymentTabletbody.classList.add('show-table');\r\n        }\r\n    };\r\n\r\n\r\n    AuthMagic.prototype.setPaymentGatAmount = function(entryid, item) {\r\n        var self = this;\r\n        Ajax.call([{\r\n            methodname: 'auth_magic_get_bankgat_amount',\r\n            args: {entryid: parseInt(entryid)},\r\n            done: function(data) {\r\n                if (data) {\r\n                    item.querySelector(\"td.cell.c5\").innerHTML = parseInt(data['amount']);\r\n                }\r\n            }\r\n        }]);\r\n    };\r\n\r\n    AuthMagic.prototype.magicCustomLoginHook = function(params) {\r\n        var self = this;\r\n        var MagicLink = self.getMagicLink(params, \"#page-auth-magic-signin\");\r\n        if (MagicLink) {\r\n            self.magicLoginHandler(MagicLink, \"form#login #id_email\", params);\r\n        }\r\n    };\r\n\r\n    AuthMagic.prototype.getMagicLink = function(params, linkId) {\r\n        var authSelector = linkId + \" .potentialidplist a[title=\\\"\" + params.strbutton + \"\\\"]\";\r\n        var MagicLink = \"\";\r\n        if (authSelector) {\r\n            MagicLink = document.querySelectorAll(authSelector)[0];\r\n            if (MagicLink === undefined) {\r\n                authSelector = linkId + \" .login-identityproviders a\";\r\n                var MagicLinks = document.querySelectorAll(authSelector);\r\n                if (MagicLinks.length) {\r\n                    MagicLinks.forEach(function(item) {\r\n                        var inner = item.innerHTML.trim();\r\n                        if (inner == params.strbutton) {\r\n                            MagicLink = item;\r\n                        }\r\n                    });\r\n                }\r\n            }\r\n        }\r\n        return MagicLink;\r\n    };\r\n\r\n    AuthMagic.prototype.magicLoginHook = function(params) {\r\n        var self = this;\r\n        var linkId = \"#page-login-index\";\r\n        var MagicLink = self.getMagicLink(params, linkId);\r\n        if (MagicLink) {\r\n            MagicLink.classList.remove(\"btn-secondary\");\r\n            MagicLink.classList.add(\"btn-primary\");\r\n            MagicLink.classList.add(\"mt-2\");\r\n            if (!document.querySelector(\"#page-login-index .potentialidplist\")) {\r\n                potentialiDpList = document.querySelectorAll(linkId + \" .login-identityproviders a\");\r\n                potentialiDp = document.querySelectorAll(linkId + \" .login-identityproviders h2\")[0];\r\n            } else {\r\n                var potentialiDp = document.querySelector(linkId + \" .potentialidplist\");\r\n                if (potentialiDp) {\r\n                    potentialiDp = potentialiDp.previousElementSibling;\r\n                }\r\n                var potentialiDpList = document.querySelectorAll(linkId + \" .potentialidplist .potentialidp\");\r\n            }\r\n            if (!params.linkbtnpos) {\r\n                params.linkbtnpos = 2;\r\n            }\r\n            if (params.linkbtnpos == 0) {\r\n                var MagicLinkBlock = document.querySelectorAll(\"#page-login-index form#login .login-form-username\")[0];\r\n                if (MagicLinkBlock) {\r\n                    MagicLinkBlock.appendChild(MagicLink);\r\n                    // Create a span.\r\n                    var span = document.createElement(\"span\");\r\n                    span.setAttribute(\"class\", \"magic-password-instruction\");\r\n                    var passInfo = String.get_string('passinfo', 'auth_magic');\r\n                    passInfo.done(function(localizedEditString) {\r\n                        span.innerHTML = localizedEditString;\r\n                    });\r\n                    MagicLinkBlock.appendChild(span);\r\n                }\r\n            }\r\n            if (params.linkbtnpos == 1) {\r\n                var MagicLinkBlock = document.querySelectorAll(\"#page-login-index form#login .login-form-password\")[0];\r\n                if (MagicLinkBlock) {\r\n                    MagicLinkBlock.appendChild(MagicLink);\r\n                }\r\n            }\r\n\r\n            if (params.linkbtnpos <= 1 ) {\r\n                if (potentialiDpList.length <= 1) {\r\n                    potentialiDp.style.display = 'none';\r\n                    var identityProvider = document.querySelectorAll(\"#page-login-index .login-identityproviders\")[0];\r\n                    if (identityProvider) {\r\n                        identityProvider.previousElementSibling.style.display = 'none';\r\n                        identityProvider.nextElementSibling.style.display = 'none';\r\n                    }\r\n                }\r\n            }\r\n\r\n            if (params.linkbtnpos == 2) {\r\n                MagicLink.classList.remove(\"btn-primary\");\r\n            }\r\n            self.magicLoginHandler(MagicLink, \"form#login #username\", params);\r\n        }\r\n    };\r\n\r\n    AuthMagic.prototype.getMagicLinkPassCheck = function() {\r\n        var emailElement = document.querySelector(\"form.login-form input[name=email]\");\r\n        var passwordElement = document.querySelector(\"form.login-form input[name=password]\");\r\n        var status = false;\r\n        if (emailElement && passwordElement) {\r\n            var args = {\r\n                email : emailElement.value,\r\n                password : passwordElement.value,\r\n            };\r\n            Ajax.call([{\r\n                methodname: 'auth_magic_get_magiclink_passcheck',\r\n                args: args,\r\n                done: function(response) {\r\n                    status = response.status;\r\n                }\r\n            }], status);\r\n        }\r\n        return status;\r\n    };\r\n\r\n    AuthMagic.prototype.magicLoginHandler = function(MagicLink, mailHandler, params) {\r\n        var self = this;\r\n        MagicLink.addEventListener(\"click\", function(e) {\r\n            e.preventDefault();\r\n            if (params.passcheck) {\r\n                // Wrong password condition give the redirect to the current data.\r\n                var loginformbutton = document.querySelector(\"form.login-form .magic-submit-action input\");\r\n                loginformbutton.click();\r\n            }\r\n\r\n            if (params.passcheck && !self.getMagicLinkPassCheck()) {\r\n                return \"\";\r\n            }\r\n            var returnurl = e.currentTarget.getAttribute(\"href\");\r\n            var userValue = \"\";\r\n            //form#login #username\r\n            var mailSelector = document.querySelectorAll(mailHandler)[0];\r\n            if (mailSelector) {\r\n                userValue = mailSelector.value;\r\n            }\r\n            // Create a form.\r\n            var form = document.createElement(\"form\");\r\n            form.setAttribute(\"method\", \"post\");\r\n            form.setAttribute(\"action\", returnurl);\r\n            form.setAttribute(\"id\", \"magic-login-form\");\r\n\r\n                // Create an input element for Full Name\r\n            var magicLogin = document.createElement(\"input\");\r\n            magicLogin.setAttribute(\"type\", \"hidden\");\r\n            magicLogin.setAttribute(\"name\", \"magiclogin\");\r\n            magicLogin.setAttribute(\"value\", 1);\r\n\r\n            var uservalue = document.createElement(\"input\");\r\n            uservalue.setAttribute(\"type\", \"hidden\");\r\n            uservalue.setAttribute(\"name\", \"uservalue\");\r\n            uservalue.setAttribute(\"value\", userValue);\r\n\r\n            form.appendChild(magicLogin);\r\n            form.appendChild(uservalue);\r\n\r\n            MagicLink.parentNode.appendChild(form);\r\n\r\n            var magicForm = document.querySelectorAll(\"form#magic-login-form\")[0];\r\n            magicForm.submit();\r\n        });\r\n    };\r\n\r\n    return {\r\n        init: function(params) {\r\n            return new AuthMagic(params);\r\n        }\r\n    };\r\n\r\n});"],"names":["define","$","String","Ajax","AuthMagic","params","loginhook","this","magicLoginHook","customloginhook","magicCustomLoginHook","paymentgatbank","paymentgatbankaction","prototype","self","paymentTabletr","document","querySelectorAll","paymentTabletbody","querySelector","append","forEach","item","element","entryid","value","setPaymentGatAmount","classList","add","call","methodname","args","parseInt","done","data","innerHTML","MagicLink","getMagicLink","magicLoginHandler","linkId","authSelector","strbutton","undefined","MagicLinks","length","trim","remove","potentialiDp","previousElementSibling","potentialiDpList","MagicLinkBlock","linkbtnpos","appendChild","span","createElement","setAttribute","get_string","localizedEditString","style","display","identityProvider","nextElementSibling","getMagicLinkPassCheck","emailElement","passwordElement","status","email","password","response","mailHandler","addEventListener","e","preventDefault","passcheck","click","returnurl","currentTarget","getAttribute","userValue","mailSelector","form","magicLogin","uservalue","parentNode","submit","init"],"mappings":"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"}