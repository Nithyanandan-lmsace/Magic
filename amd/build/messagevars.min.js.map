{"version":3,"file":"messagevars.min.js","sources":["../src/messagevars.js"],"sourcesContent":["// This file is part of Moodle - http://moodle.org/\r\n//\r\n// Moodle is free software: you can redistribute it and/or modify\r\n// it under the terms of the GNU General Public License as published by\r\n// the Free Software Foundation, either version 3 of the License, or\r\n// (at your option) any later version.\r\n//\r\n// Moodle is distributed in the hope that it will be useful,\r\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\r\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\r\n// GNU General Public License for more details.\r\n//\r\n// You should have received a copy of the GNU General Public License\r\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\r\n\r\n/**\r\n * Magic campaign welcome and follow up message placeholders define js.\r\n *\r\n * @module   auth_magic\r\n * @copyright  2023 bdecent gmbh <https://bdecent.de>\r\n * @license   http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\r\n */\r\n\r\ndefine([], function() {\r\n\r\n    return {\r\n\r\n        /**\r\n         * Setup the classes to editors works with placeholders.\r\n         */\r\n        init: function() {\r\n            var messageVars = this;\r\n            var notificationheader = document.getElementById('id_welcomemessagesection_editor');\r\n            if (notificationheader !== null) {\r\n                notificationheader.addEventListener('click', function() {\r\n                    var EditorInput = document.getElementById('id_welcomemessagecontent_editoreditable');\r\n                    if (EditorInput !== null) {\r\n                        messageVars.insertCaretActive(EditorInput);\r\n                    }\r\n                });\r\n            }\r\n\r\n            var notificationheader = document.getElementById('id_followupmessagesection');\r\n            if (notificationheader !== null) {\r\n                notificationheader.addEventListener('click', function() {\r\n                    var EditorInput = document.getElementById('id_followupmessagecontent_editoreditable');\r\n                    if (EditorInput !== null) {\r\n                        messageVars.insertCaretActive(EditorInput);\r\n                    }\r\n                });\r\n            }\r\n\r\n            var notificationheader = document.getElementById('id_aftersubmisson');\r\n            if (notificationheader !== null) {\r\n                notificationheader.addEventListener('click', function() {\r\n                    var EditorInput = document.getElementById('id_submissioncontent_editoreditable');\r\n                    if (EditorInput !== null) {\r\n                        messageVars.insertCaretActive(EditorInput);\r\n                    }\r\n                });\r\n            }\r\n\r\n\r\n\r\n            var targetNode = document.querySelector('textarea[id$=_editor]');\r\n            if (targetNode !== null) {\r\n                var observer = new MutationObserver(function() {\r\n                    if (targetNode.style.display == 'none') {\r\n                        setTimeout(initIframeListeners, 100);\r\n                    }\r\n                });\r\n                observer.observe(targetNode, {attributes: true, childList: true});\r\n            }\r\n\r\n            const initIframeListeners = () => {\r\n                var iframes = document.querySelectorAll('[data-fieldtype=\"editor\"] iframe');\r\n                if (iframes === null || !iframes.length) {\r\n                    return false;\r\n                }\r\n                iframes.forEach((iframe) => {\r\n                    iframe.contentDocument.addEventListener('click', function(e) {\r\n                        var currentFrame = e.target;\r\n                        iframes.forEach((frame) => {\r\n                            var frameElem = frame.contentDocument.querySelector(\".insertatcaretactive\");\r\n                            if (frameElem !== null) {\r\n                                frameElem.classList.remove(\"insertatcaretactive\");\r\n                            }\r\n                        });\r\n\r\n                        var contentBody = currentFrame.querySelector('body');\r\n                        if (contentBody !== null) {\r\n                            contentBody.classList.add(\"insertatcaretactive\");\r\n                        }\r\n                    });\r\n                });\r\n\r\n                return true;\r\n            };\r\n\r\n\r\n            var clickforword = document.getElementsByClassName('campaign-message-clickforword');\r\n            for (var i = 0; i < clickforword.length; i++) {\r\n                clickforword[i].addEventListener('click', function(e) {\r\n                    e.preventDefault(); // To prevent the default behaviour of a tag.\r\n                    var tinyEditor = false;\r\n                    var content = \"{\" + this.getAttribute('data-text') + \"}\";\r\n                    var iframes = document.querySelectorAll('[data-fieldtype=\"editor\"] iframe');\r\n                    if (iframes === null || !iframes.length) {\r\n                        messageVars.insertAtCaret(content);\r\n                        return true;\r\n                    }\r\n                    iframes.forEach(function(frame) {\r\n                        var frameElem = frame.contentDocument.querySelector(\".insertatcaretactive\");\r\n                        if (frameElem !== null) {\r\n                            var contentBody = frame.contentDocument.querySelector('body');\r\n                            if (contentBody !== null) {\r\n                                contentBody.classList.add(\"insertatcaretactive\");\r\n                                var id = contentBody.dataset.id;\r\n                                var editor = window.tinyMCE.get(id);\r\n                                tinyEditor = editor;\r\n                            }\r\n                        }\r\n                    });\r\n\r\n                    if (tinyEditor) {\r\n                        tinyEditor.selection.setContent(content);\r\n                    } else {\r\n                        messageVars.insertAtCaret(content);\r\n                    }\r\n\r\n                    return true;\r\n                });\r\n            }\r\n        },\r\n\r\n        insertCaretActive: function(EditorInput) {\r\n            var caret = document.getElementsByClassName(\"insertatcaretactive\");\r\n            for (var j = 0; j < caret.length; j++) {\r\n                caret[j].classList.remove(\"insertatcaretactive\");\r\n            }\r\n            EditorInput.classList.add(\"insertatcaretactive\");\r\n        },\r\n\r\n        /**\r\n         * Insert the placeholder in selected caret place.\r\n         * @param  {string} myValue\r\n         */\r\n        insertAtCaret: function(myValue) {\r\n            var caretelements = document.getElementsByClassName(\"insertatcaretactive\");\r\n            var sel, range;\r\n            for (var n = 0; n < caretelements.length; n++) {\r\n                var thiselem = caretelements[n];\r\n\r\n                if (typeof thiselem.value === 'undefined' && window.getSelection) {\r\n                    sel = window.getSelection();\r\n                    if (sel.getRangeAt && sel.rangeCount) {\r\n                        range = sel.getRangeAt(0);\r\n                        range.deleteContents();\r\n                        range.insertNode(document.createTextNode(myValue));\r\n\r\n                        for (let position = 0; position != (myValue.length + 1); position++) {\r\n                            sel.modify(\"move\", \"right\", \"character\");\r\n                        }\r\n                    }\r\n                } else if (typeof thiselem.value === 'undefined' && document.selection && document.selection.createRange) {\r\n                    range = document.selection.createRange();\r\n                    range.text = myValue;\r\n                }\r\n\r\n                if (typeof thiselem.value !== 'undefined') {\r\n                    if (document.selection) {\r\n                        // For browsers like Internet Explorer.\r\n                        thiselem.focus();\r\n                        sel = document.selection.createRange();\r\n                        sel.text = myValue;\r\n                        thiselem.focus();\r\n                    } else if (thiselem.selectionStart || thiselem.selectionStart == '0') {\r\n                        // For browsers like Firefox and Webkit based.\r\n                        var startPos = thiselem.selectionStart;\r\n                        var endPos = thiselem.selectionEnd;\r\n                        thiselem.value = thiselem.value.substring(0, startPos)\r\n                            + myValue + thiselem.value.substring(endPos, thiselem.value.length);\r\n                        thiselem.focus();\r\n                        thiselem.selectionStart = startPos + myValue.length;\r\n                        thiselem.selectionEnd = startPos + myValue.length;\r\n                        thiselem.focus();\r\n                    } else {\r\n                        thiselem.value += myValue;\r\n                        thiselem.focus();\r\n                    }\r\n                }\r\n            }\r\n        },\r\n    };\r\n});\r\n"],"names":["define","init","notificationheader","messageVars","this","document","getElementById","addEventListener","EditorInput","insertCaretActive","targetNode","querySelector","MutationObserver","style","display","setTimeout","initIframeListeners","observe","attributes","childList","iframes","querySelectorAll","length","forEach","iframe","contentDocument","e","currentFrame","target","frame","frameElem","classList","remove","contentBody","add","clickforword","getElementsByClassName","i","preventDefault","tinyEditor","content","getAttribute","id","dataset","editor","window","tinyMCE","get","selection","setContent","insertAtCaret","caret","j","myValue","sel","range","caretelements","n","thiselem","value","getSelection","getRangeAt","rangeCount","deleteContents","insertNode","createTextNode","position","modify","createRange","text","focus","selectionStart","startPos","endPos","selectionEnd","substring"],"mappings":"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"}