{"version":3,"file":"messagevars.min.js","sources":["../src/messagevars.js"],"sourcesContent":["// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n/**\n * Magic campaign welcome and follow up message placeholders define js.\n *\n * @module   auth_magic\n * @copyright  2023 bdecent gmbh <https://bdecent.de>\n * @license   http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\n\ndefine([], function() {\n\n    return {\n\n        /**\n         * Setup the classes to editors works with placeholders.\n         */\n        init: function() {\n            var messageVars = this;\n            var notificationheader = document.getElementById('id_welcomemessagesection_editor');\n            if (notificationheader !== null) {\n                notificationheader.addEventListener('click', function() {\n                    var EditorInput = document.getElementById('id_welcomemessagecontent_editoreditable');\n                    if (EditorInput !== null) {\n                        messageVars.insertCaretActive(EditorInput);\n                    }\n                });\n            }\n\n            var notificationheader = document.getElementById('id_followupmessagesection');\n            if (notificationheader !== null) {\n                notificationheader.addEventListener('click', function() {\n                    var EditorInput = document.getElementById('id_followupmessagecontent_editoreditable');\n                    if (EditorInput !== null) {\n                        messageVars.insertCaretActive(EditorInput);\n                    }\n                });\n            }\n\n            var notificationheader = document.getElementById('id_aftersubmisson');\n            if (notificationheader !== null) {\n                notificationheader.addEventListener('click', function() {\n                    var EditorInput = document.getElementById('id_submissioncontent_editoreditable');\n                    if (EditorInput !== null) {\n                        messageVars.insertCaretActive(EditorInput);\n                    }\n                });\n            }\n\n\n\n            var targetNode = document.querySelector('textarea[id$=_editor]');\n            if (targetNode !== null) {\n                var observer = new MutationObserver(function() {\n                    if (targetNode.style.display == 'none') {\n                        setTimeout(initIframeListeners, 100);\n                    }\n                });\n                observer.observe(targetNode, {attributes: true, childList: true});\n            }\n\n            const initIframeListeners = () => {\n                var iframes = document.querySelectorAll('[data-fieldtype=\"editor\"] iframe');\n                if (iframes === null || !iframes.length) {\n                    return false;\n                }\n                iframes.forEach((iframe) => {\n                    iframe.contentDocument.addEventListener('click', function(e) {\n                        var currentFrame = e.target;\n                        iframes.forEach((frame) => {\n                            var frameElem = frame.contentDocument.querySelector(\".insertatcaretactive\");\n                            if (frameElem !== null) {\n                                frameElem.classList.remove(\"insertatcaretactive\");\n                            }\n                        });\n\n                        var contentBody = currentFrame.querySelector('body');\n                        if (contentBody !== null) {\n                            contentBody.classList.add(\"insertatcaretactive\");\n                        }\n                    });\n                });\n\n                return true;\n            };\n\n\n            var clickforword = document.getElementsByClassName('campaign-message-clickforword');\n            for (var i = 0; i < clickforword.length; i++) {\n                clickforword[i].addEventListener('click', function(e) {\n                    e.preventDefault(); // To prevent the default behaviour of a tag.\n                    var tinyEditor = false;\n                    var content = \"{\" + this.getAttribute('data-text') + \"}\";\n                    var iframes = document.querySelectorAll('[data-fieldtype=\"editor\"] iframe');\n                    if (iframes === null || !iframes.length) {\n                        messageVars.insertAtCaret(content);\n                        return true;\n                    }\n                    iframes.forEach(function(frame) {\n                        var frameElem = frame.contentDocument.querySelector(\".insertatcaretactive\");\n                        if (frameElem !== null) {\n                            var contentBody = frame.contentDocument.querySelector('body');\n                            if (contentBody !== null) {\n                                contentBody.classList.add(\"insertatcaretactive\");\n                                var id = contentBody.dataset.id;\n                                var editor = window.tinyMCE.get(id);\n                                tinyEditor = editor;\n                            }\n                        }\n                    });\n\n                    if (tinyEditor) {\n                        tinyEditor.selection.setContent(content);\n                    } else {\n                        messageVars.insertAtCaret(content);\n                    }\n\n                    return true;\n                });\n            }\n        },\n\n        insertCaretActive: function(EditorInput) {\n            var caret = document.getElementsByClassName(\"insertatcaretactive\");\n            for (var j = 0; j < caret.length; j++) {\n                caret[j].classList.remove(\"insertatcaretactive\");\n            }\n            EditorInput.classList.add(\"insertatcaretactive\");\n        },\n\n        /**\n         * Insert the placeholder in selected caret place.\n         * @param  {string} myValue\n         */\n        insertAtCaret: function(myValue) {\n            var caretelements = document.getElementsByClassName(\"insertatcaretactive\");\n            var sel, range;\n            for (var n = 0; n < caretelements.length; n++) {\n                var thiselem = caretelements[n];\n\n                if (typeof thiselem.value === 'undefined' && window.getSelection) {\n                    sel = window.getSelection();\n                    if (sel.getRangeAt && sel.rangeCount) {\n                        range = sel.getRangeAt(0);\n                        range.deleteContents();\n                        range.insertNode(document.createTextNode(myValue));\n\n                        for (let position = 0; position != (myValue.length + 1); position++) {\n                            sel.modify(\"move\", \"right\", \"character\");\n                        }\n                    }\n                } else if (typeof thiselem.value === 'undefined' && document.selection && document.selection.createRange) {\n                    range = document.selection.createRange();\n                    range.text = myValue;\n                }\n\n                if (typeof thiselem.value !== 'undefined') {\n                    if (document.selection) {\n                        // For browsers like Internet Explorer.\n                        thiselem.focus();\n                        sel = document.selection.createRange();\n                        sel.text = myValue;\n                        thiselem.focus();\n                    } else if (thiselem.selectionStart || thiselem.selectionStart == '0') {\n                        // For browsers like Firefox and Webkit based.\n                        var startPos = thiselem.selectionStart;\n                        var endPos = thiselem.selectionEnd;\n                        thiselem.value = thiselem.value.substring(0, startPos)\n                            + myValue + thiselem.value.substring(endPos, thiselem.value.length);\n                        thiselem.focus();\n                        thiselem.selectionStart = startPos + myValue.length;\n                        thiselem.selectionEnd = startPos + myValue.length;\n                        thiselem.focus();\n                    } else {\n                        thiselem.value += myValue;\n                        thiselem.focus();\n                    }\n                }\n            }\n        },\n    };\n});\n"],"names":["define","init","notificationheader","messageVars","this","document","getElementById","addEventListener","EditorInput","insertCaretActive","targetNode","querySelector","MutationObserver","style","display","setTimeout","initIframeListeners","observe","attributes","childList","iframes","querySelectorAll","length","forEach","iframe","contentDocument","e","currentFrame","target","frame","frameElem","classList","remove","contentBody","add","clickforword","getElementsByClassName","i","preventDefault","tinyEditor","content","getAttribute","id","dataset","editor","window","tinyMCE","get","selection","setContent","insertAtCaret","caret","j","myValue","sel","range","caretelements","n","thiselem","value","getSelection","getRangeAt","rangeCount","deleteContents","insertNode","createTextNode","position","modify","createRange","text","focus","selectionStart","startPos","endPos","selectionEnd","substring"],"mappings":"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"}